<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SprintTrack - Отслеживание активности</title>
    <!-- Tailwind CSS CDN для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Шрифт Inter для гармоничного и современного вида -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Основные стили для тела страницы, градиентный фон для жизнерадостности */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #cbebff 100%); /* Светло-голубой градиент */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            color: #333;
        }
        /* Стили для основного контейнера приложения/форм */
        .container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 1200px;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        /* Общие стили для кнопок */
        .btn {
            padding: 12px 25px;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        /* Стили для основной кнопки (градиент) */
        .btn-primary {
            background: linear-gradient(45deg, #6a82fb 0%, #fc5c7d 100%); /* Яркий градиент */
            color: white;
            border: none;
        }
        /* Эффект при наведении на основную кнопку */
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        /* Стили для второстепенной кнопки */
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4a5568;
            border: none;
        }
        /* Эффект при наведении на второстепенную кнопку */
        .btn-secondary:hover {
            background-color: #cbd5e0;
        }
        /* Стили для полей ввода */
        .input-field {
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #cbd5e0;
            width: 100%;
            font-size: 1rem;
            color: #4a5568;
            transition: border-color 0.3s ease;
        }
        /* Эффект при фокусе на поле ввода */
        .input-field:focus {
            outline: none;
            border-color: #6a82fb;
            box-shadow: 0 0 0 3px rgba(106, 130, 251, 0.2);
        }
        /* Стили для контейнера карты Google Maps */
        #map {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        /* Стили для модального окна */
        .modal {
            display: none; /* Скрыто по умолчанию */
            position: fixed; /* Остается на месте */
            z-index: 1000; /* Поверх всего */
            left: 0;
            top: 0;
            width: 100%; /* Полная ширина */
            height: 100%; /* Полная высота */
            overflow: auto; /* Прокрутка, если содержимое больше */
            background-color: rgba(0,0,0,0.4); /* Черный с прозрачностью */
            justify-content: center;
            align-items: center;
        }
        /* Стили для содержимого модального окна */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        /* Стили для кнопки закрытия модального окна */
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Стили для кнопок вкладок */
        .tab-button {
            padding: 10px 20px;
            border-radius: 10px;
            background-color: #edf2f7;
            color: #4a5568;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        /* Стили для активной кнопки вкладки (градиент) */
        .tab-button.active {
            background: linear-gradient(45deg, #6a82fb 0%, #fc5c7d 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* Стили для карточек информации */
        .card {
            background-color: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        /* Стили для кнопки SOS */
        .btn-sos {
            background-color: #ef4444; /* Красный цвет */
            color: white;
            border: none;
        }
        .btn-sos:hover {
            background-color: #dc2626; /* Темнее красный при наведении */
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <h1 class="text-4xl font-bold text-gray-800 mb-6 mt-4">SprintTrack</h1>

    <!-- Секция аутентификации -->
    <div id="auth-section" class="container text-center">
        <h2 class="text-2xl font-semibold mb-6">Вход в SprintTrack</h2>
        <div class="mb-4">
            <input type="text" id="username" placeholder="Имя пользователя" class="input-field mb-3">
            <input type="password" id="password" placeholder="Пароль" class="input-field">
        </div>
        <button id="login-btn" class="btn btn-primary w-full">Войти</button>
        <p id="auth-message" class="text-red-500 mt-3"></p>
    </div>

    <!-- Основная секция приложения (скрыта до аутентификации) -->
    <div id="app-section" class="container hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold">Привет, <span id="current-user-display"></span>!</h2>
            <button id="logout-btn" class="btn btn-secondary">Выйти</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Карта и элементы управления -->
            <div class="lg:col-span-2 card p-5">
                <h3 class="text-xl font-semibold mb-4">Ваш маршрут</h3>
                <div id="map"></div>
                <p id="map-status" class="text-red-500 mb-4"></p>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button id="start-tracking-btn" class="btn btn-primary flex-grow"><i class="fas fa-play"></i> Начать отслеживание</button>
                    <button id="stop-tracking-btn" class="btn btn-secondary flex-grow" disabled><i class="fas fa-stop"></i> Остановить</button>
                    <button id="share-route-btn" class="btn btn-secondary flex-grow" disabled><i class="fas fa-share-alt"></i> Поделиться</button>
                    <button id="sos-btn" class="btn btn-sos flex-grow"><i class="fas fa-exclamation-triangle"></i> SOS</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <p class="text-lg font-medium">Текущая скорость:</p>
                        <p class="text-3xl font-bold text-blue-600"><span id="current-speed">0.00</span> км/ч</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-lg font-medium">Пройденное расстояние:</p>
                        <p class="text-3xl font-bold text-purple-600"><span id="distance-traveled">0.00</span> км</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-lg font-medium">Время в пути:</p>
                        <p class="text-3xl font-bold text-green-600"><span id="time-elapsed">00:00:00</span></p>
                    </div>
                    <div class="card p-4">
                        <p class="text-lg font-medium">Средняя скорость:</p>
                        <p class="text-3xl font-bold text-orange-600"><span id="average-speed">0.00</span> км/ч</p>
                    </div>
                </div>
            </div>

            <!-- Настройки и статистика -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Выбор типа передвижения -->
                <div class="card p-5">
                    <h3 class="text-xl font-semibold mb-4">Тип передвижения</h3>
                    <select id="movement-type-select" class="input-field mb-4">
                        <option value="walking">Пешком</option>
                        <option value="cycling">Велосипед</option>
                        <option value="ebike">E-bike</option>
                        <option value="roadbike">Шоссейный велосипед</option>
                        <option value="mountainbike">Горный велосипед</option>
                    </select>

                    <!-- Опции для "Пешком" -->
                    <div id="walking-options" class="hidden">
                        <label class="block mb-2"><input type="radio" name="walking-mode" value="sprint" checked> Спринт</label>
                        <label class="block mb-2"><input type="radio" name="walking-mode" value="walk"> Ходьба</label>
                        <label class="block mb-2"><input type="radio" name="walking-mode" value="run"> Бег</label>
                        <label class="block mb-2"><input type="radio" name="walking-mode" value="hiking"> Хайкинг</label>
                    </div>

                    <!-- Опции для "Велосипед" -->
                    <div id="cycling-options" class="hidden">
                        <label class="block mb-2"><input type="radio" name="cycling-mode" value="balanced" checked> Сбалансированный</label>
                        <p class="text-sm text-gray-600 mb-2">Включает велосипедные дорожки и улицы с низким трафиком. Избегает улиц с ограничением скорости выше 50 км/ч.</p>
                        <label class="block mb-2"><input type="radio" name="cycling-mode" value="shortest"> Самый короткий</label>
                        <p class="text-sm text-gray-600 mb-2">Сокращенное количество поворотов и более короткий маршрут. Велодорожкам уделяется меньше внимания, что может привести к большему объему движения на маршруте.</p>
                        <label class="block mb-2"><input type="radio" name="cycling-mode" value="bikepaths"> Велосипедные дорожки</label>
                        <p class="text-sm text-gray-600 mb-2">Велодорожки предпочтительнее, чем другие дороги, если удлинение маршрута незначительно.</p>
                        <label class="block mb-2"><input type="radio" name="cycling-mode" value="popular"> Популярные</label>
                        <p class="text-sm text-gray-600 mb-2">Маршруты, предпочтительные для нашего велосипедного сообщества, основанные на данных нашей тепловой карты.</p>
                    </div>

                    <!-- Описание для "E-bike" -->
                    <div id="ebike-options" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Включает больше перепадов высот и избегает ступеней, на которых придётся нести велосипед.</p>
                    </div>

                    <!-- Описание для "Плавная езда" (общая концепция, не отдельный тип) -->
                    <div id="smooth-ride-options" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Приоритет на комфорт и безопасность, избегает препятствий, таких как лестницы, встроенные рельсы, гравий, песок, брусчатка и плотное движение.</p>
                    </div>

                    <!-- Описание для "Шоссейный велосипед" -->
                    <div id="roadbike-options" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Оптимизирует поездку для скорости и эффективности. Непокрытые дороги будут избегаться по возможности.</p>
                    </div>

                    <!-- Описание для "Горный велосипед" -->
                    <div id="mountainbike-options" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Включите пересечённую местность, маршруты для горных велосипедов и больше перепадов высот на маршруте.</p>
                    </div>
                </div>

                <!-- Вкладки для Истории, Избранного, Рейтинга и Рекомендуемых -->
                <div class="card p-5 flex-grow">
                    <div class="flex mb-4 border-b border-gray-200 overflow-x-auto pb-2">
                        <button id="history-tab-btn" class="tab-button active mr-2 whitespace-nowrap">Мои маршруты</button>
                        <button id="favorites-tab-btn" class="tab-button mr-2 whitespace-nowrap">Избранное</button>
                        <button id="leaderboard-tab-btn" class="tab-button mr-2 whitespace-nowrap">Рейтинг</button>
                        <button id="recommended-tab-btn" class="tab-button whitespace-nowrap">Рекомендуемые</button>
                    </div>

                    <!-- Контент вкладки "Мои маршруты" -->
                    <div id="history-content">
                        <h3 class="text-xl font-semibold mb-4">Последние маршруты</h3>
                        <div id="routes-list" class="space-y-3">
                            <!-- Маршруты будут загружены здесь -->
                            <p class="text-gray-500">Маршруты пока не загружены.</p>
                        </div>
                    </div>

                    <!-- Контент вкладки "Избранное" (скрыт по умолчанию) -->
                    <div id="favorites-content" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">Избранные маршруты</h3>
                        <div id="favorites-list" class="space-y-3">
                            <p class="text-gray-500">Избранные маршруты пока не найдены.</p>
                        </div>
                    </div>

                    <!-- Контент вкладки "Рейтинг" (скрыт по умолчанию) -->
                    <div id="leaderboard-content" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">Рейтинг участников</h3>
                        <div id="leaderboard-list" class="space-y-3">
                            <!-- Рейтинг будет загружен здесь -->
                            <p class="text-gray-500">Рейтинг пока не загружен.</p>
                        </div>
                    </div>

                    <!-- Контент вкладки "Рекомендуемые" (скрыт по умолчанию) -->
                    <div id="recommended-content" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">Рекомендуемые маршруты</h3>
                        <div id="recommended-list" class="space-y-3">
                            <p class="text-gray-500">Рекомендуемые маршруты пока не загружены.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Пользовательское модальное окно для сообщений (вместо alert/confirm) -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message" class="text-lg font-medium text-gray-700"></p>
            <button id="modal-close-btn" class="btn btn-primary mt-5">ОК</button>
        </div>
    </div>

    <!-- Модальное окно для подтверждения повторения маршрута -->
    <div id="repeat-confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p class="text-lg font-medium text-gray-700 mb-4">Вы уверены, что хотите повторить этот маршрут?</p>
            <p class="text-sm text-gray-600 mb-6">Ваш текущий прогресс отслеживания будет сброшен.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-repeat-btn" class="btn btn-primary">Повторить</button>
                <button id="cancel-repeat-btn" class="btn btn-secondary">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для SOS -->
    <div id="sos-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p class="text-2xl font-bold text-red-600 mb-4"><i class="fas fa-exclamation-triangle"></i> SOS Активирован!</p>
            <p class="text-lg font-medium text-gray-700 mb-4">Ваше текущее местоположение:</p>
            <p id="sos-location" class="text-md text-gray-800 font-semibold mb-6">Определение местоположения...</p>
            <p class="text-sm text-gray-600">В реальном приложении здесь будет отправлено сообщение экстренным контактам.</p>
            <button id="sos-close-btn" class="btn btn-primary mt-5">Закрыть</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Импорт необходимых модулей Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, limit, orderBy, addDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобальные переменные, предоставленные средой Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Ваша конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBaO6MfwDB0CCgvDto7VmHgJxN_e-ZsIgE",
            authDomain: "sprinttrack-941b5.firebaseapp.com",
            projectId: "sprinttrack-941b5",
            storageBucket: "sprinttrack-941b5.firebasestorage.app",
            messagingSenderId: "235437842194",
            appId: "1:235437842194:web:a8c47588fac613503a1dcb",
            measurementId: "G-SQ2TE2V5D3"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // Переменные для инициализации Firebase
        let app, db, auth;
        let currentFirebaseUser = null; // Пользователь Firebase Auth
        let currentAppUser = null;      // Наш пользователь приложения (например, 'Renard')

        // Инициализация Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Всегда пытаемся войти анонимно при запуске
            signInAnonymously(auth).then((userCredential) => {
                currentFirebaseUser = userCredential.user;
                console.log("Firebase signed in anonymously:", currentFirebaseUser.uid);
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                // Отображаем UID анонимного пользователя или "Гость"
                document.getElementById('current-user-display').textContent = 'Гость (' + currentFirebaseUser.uid.substring(0, 8) + '...)';
            }).catch((error) => {
                console.error("Error signing in anonymously:", error);
                showModal("Критическая ошибка Firebase при анонимном входе: " + error.message);
            });

            // Слушатель изменений состояния аутентификации
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentFirebaseUser = user;
                    console.log("Auth state changed, user:", user.uid);
                    // Если вошел пользователь приложения (через 'Renard'), используем его имя
                    // Иначе (для анонимного входа), отображаем 'Гость'
                    if (!currentAppUser) {
                        document.getElementById('current-user-display').textContent = 'Гость (' + user.uid.substring(0, 8) + '...)';
                    }
                    // Загружаем данные после готовности аутентификации
                    if (currentAppUser) { // Только если вошел конкретный именованный пользователь
                        loadUserRoutes(currentAppUser);
                        loadFavoriteRoutes(currentAppUser); // Загрузка избранных маршрутов
                    }
                    loadLeaderboard();
                    loadRecommendedRoutes(); // Загрузка рекомендуемых маршрутов
                } else {
                    currentFirebaseUser = null;
                    currentAppUser = null;
                    console.log("User logged out from Firebase.");
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('app-section').classList.add('hidden');
                }
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showModal("Ошибка инициализации Firebase: " + e.message + ". Убедитесь, что конфигурация Firebase корректна.");
        }


        // --- Пользовательская логика входа ---
        // Заранее определенные пользователи (для демонстрации, в реальном приложении использовать Firebase Auth)
        const predefinedUsers = {
            'Renard': '121212'
        };

        document.getElementById('login-btn').addEventListener('click', () => {
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;
            const authMessage = document.getElementById('auth-message');

            if (predefinedUsers[usernameInput] && predefinedUsers[usernameInput] === passwordInput) {
                currentAppUser = usernameInput;
                authMessage.textContent = '';
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-section').classList.remove('hidden');
                document.getElementById('current-user-display').textContent = usernameInput;
                loadUserRoutes(currentAppUser);
                loadFavoriteRoutes(currentAppUser); // Загрузка избранных маршрутов
                loadLeaderboard(); // Перезагружаем рейтинг, так как пользователь мог быть новым
                loadRecommendedRoutes(); // Загрузка рекомендуемых маршрутов
            } else {
                authMessage.textContent = 'Неверное имя пользователя или пароль.';
            }
        });

        // Кнопка выхода из системы
        document.getElementById('logout-btn').addEventListener('click', () => {
            currentAppUser = null;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            // Очищаем карту и статистику при выходе
            if (map) {
                pathPolyline.setPath([]);
                if (targetRoutePolyline) targetRoutePolyline.setMap(null); // Скрываем целевой маршрут
                map.setCenter(initialMapCenter);
                map.setZoom(initialMapZoom);
                currentMarker.setPosition(initialMapCenter); // Сбрасываем маркер
            }
            document.getElementById('current-speed').textContent = '0.00';
            document.getElementById('distance-traveled').textContent = '0.00';
            document.getElementById('time-elapsed').textContent = '00:00:00';
            document.getElementById('average-speed').textContent = '0.00';
            document.getElementById('routes-list').innerHTML = '<p class="text-gray-500">Маршруты пока не загружены.</p>';
            document.getElementById('favorites-list').innerHTML = '<p class="text-gray-500">Избранные маршруты пока не найдены.</p>';
            document.getElementById('leaderboard-list').innerHTML = '<p class="text-gray-500">Рейтинг пока не загружен.</p>';
            document.getElementById('recommended-list').innerHTML = '<p class="text-gray-500">Рекомендуемые маршруты пока не загружены.</p>';
        });


        // --- Google Maps и Геолокация ---
        let map;
        let initialMapCenter = { lat: 48.0196, lng: 66.9237 }; // Центр Казахстана по умолчанию
        let initialMapZoom = 5;
        let trackingId = null; // ID для watchPosition
        let pathCoordinates = []; // Координаты текущего маршрута
        let pathPolyline; // Объект полилинии на карте (текущий маршрут пользователя)
        let targetRoutePolyline; // Объект полилинии для повторяемого/целевого маршрута
        let currentMarker = null; // Маркер для текущего местоположения
        let startTime = null; // Время начала отслеживания
        let totalDistance = 0; // Общее пройденное расстояние
        let lastPosition = null; // Последняя известная позиция
        let repeatingRoutePath = null; // Сохраняет путь маршрута, который повторяется

        // Функция для отображения пользовательского модального окна
        function showModal(message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex'; // Показываем модальное окно
        }

        // Слушатели событий для закрытия модального окна
        document.querySelector('#message-modal .close-button').addEventListener('click', () => {
            document.getElementById('message-modal').style.display = 'none';
        });
        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('message-modal').style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            if (event.target == document.getElementById('message-modal')) {
                document.getElementById('message-modal').style.display = 'none';
            }
        });

        // Модальное окно подтверждения повторения маршрута
        const repeatConfirmModal = document.getElementById('repeat-confirm-modal');
        document.getElementById('cancel-repeat-btn').addEventListener('click', () => {
            repeatConfirmModal.style.display = 'none';
            repeatingRoutePath = null; // Сбрасываем выбранный маршрут
        });

        // Модальное окно SOS
        document.querySelector('#sos-modal .close-button').addEventListener('click', () => {
            document.getElementById('sos-modal').style.display = 'none';
        });
        document.getElementById('sos-close-btn').addEventListener('click', () => {
            document.getElementById('sos-modal').style.display = 'none';
        });
        document.getElementById('sos-btn').addEventListener('click', handleSOS);


        // Инициализация карты Google Maps
        window.initMap = function() {
            console.log("Initializing map...");
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error("Map element not found!");
                return;
            }

            map = new google.maps.Map(mapElement, {
                center: initialMapCenter,
                zoom: initialMapZoom,
                mapTypeId: 'satellite', // Вид со спутника
                fullscreenControl: false,
                mapTypeControl: false,
                streetViewControl: false,
                zoomControl: true,
                scaleControl: true,
            });

            // Создаем полилинию для отображения текущего маршрута пользователя
            pathPolyline = new google.maps.Polyline({
                path: [],
                geodesic: true,
                strokeColor: '#FF0000', /* Красный цвет для пути пользователя */
                strokeOpacity: 1.0,
                strokeWeight: 4
            });
            pathPolyline.setMap(map);

            // Создаем полилинию для отображения целевого/повторяемого маршрута
            targetRoutePolyline = new google.maps.Polyline({
                path: [],
                geodesic: true,
                strokeColor: '#0000FF', /* Синий цвет для целевого маршрута */
                strokeOpacity: 0.7,
                strokeWeight: 5,
                zIndex: 1 // Чтобы был под текущим маршрутом
            });
            // targetRoutePolyline.setMap(map); // Изначально скрыт, показывается при повторении маршрута

            document.getElementById('map-status').textContent = 'Карта загружена. Ожидание разрешения GPS...';
            console.log("Map initialized.");

            // Добавляем маркер текущего местоположения
            currentMarker = new google.maps.Marker({
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#4285F4', // Синий цвет
                    fillOpacity: 1,
                    strokeWeight: 0
                },
                zIndex: 999 // Чтобы маркер был поверх полилинии
            });


            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(pos);
                        map.setZoom(15);
                        currentMarker.setPosition(pos); // Устанавливаем позицию маркера
                        document.getElementById('map-status').textContent = 'GPS доступен. Ваше текущее местоположение показано на карте.';
                        console.log("Initial GPS position obtained and marker set.");
                    },
                    (error) => {
                        handleLocationError(true, map.getCenter(), error);
                    }
                );
            } else {
                // Браузер не поддерживает геолокацию
                handleLocationError(false, map.getCenter(), null);
            }
        };

        // Обработка ошибок геолокации
        function handleLocationError(browserHasGeolocation, pos, error) {
            let errorMessage = '';
            if (browserHasGeolocation) {
                errorMessage = 'Ошибка: Служба геолокации не удалась. ';
                if (error) {
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += "Доступ к местоположению запрещен. Пожалуйста, разрешите доступ к GPS в настройках браузера.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += "Информация о местоположении недоступна. Пожалуйста, проверьте сигнал GPS.";
                            break;
                        case error.TIMEOUT:
                            errorMessage += "Время ожидания запроса местоположения истекло. Пожалуйста, попробуйте еще раз.";
                            break;
                        default:
                            errorMessage += "Неизвестная ошибка: " + error.message;
                            break;
                    }
                } else {
                    errorMessage += "Неизвестная ошибка получения местоположения.";
                }
            } else {
                errorMessage = 'Ошибка: Ваш браузер не поддерживает геолокацию.';
            }
            document.getElementById('map-status').textContent = errorMessage;
            showModal(errorMessage);
            console.error("Geolocation Error:", errorMessage, error);
        }

        // --- Логика отслеживания ---
        document.getElementById('start-tracking-btn').addEventListener('click', () => {
            if (!map) {
                showModal("Карта еще не загружена. Пожалуйста, подождите.");
                return;
            }
            if (!navigator.geolocation) {
                showModal("Ваш браузер не поддерживает геолокацию.");
                return;
            }

            // Отключаем кнопку "Начать" и включаем "Остановить"
            document.getElementById('start-tracking-btn').disabled = true;
            document.getElementById('stop-tracking-btn').disabled = false;
            document.getElementById('share-route-btn').disabled = true;

            pathCoordinates = []; // Очищаем координаты пути
            totalDistance = 0; // Сбрасываем расстояние
            startTime = new Date().getTime(); // Записываем время начала
            lastPosition = null; // Сбрасываем последнюю позицию
            pathPolyline.setPath([]); // Очищаем полилинию на карте

            // Если повторяем маршрут, показываем его на карте
            if (repeatingRoutePath) {
                targetRoutePolyline.setPath(repeatingRoutePath);
                targetRoutePolyline.setMap(map);
                const bounds = new google.maps.LatLngBounds();
                repeatingRoutePath.forEach(coord => bounds.extend(coord));
                map.fitBounds(bounds); // Подгоняем карту под целевой маршрут
                document.getElementById('map-status').textContent = 'Отслеживание начато. Вы следуете по выбранному маршруту.';
            } else {
                document.getElementById('map-status').textContent = 'Отслеживание начато...';
            }
            console.log("Tracking started.");

            // Начинаем отслеживание позиции
            trackingId = navigator.geolocation.watchPosition(
                (position) => {
                    const newPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    map.setCenter(newPos); // Центрируем карту на текущей позиции
                    currentMarker.setPosition(newPos); // Обновляем позицию маркера

                    if (lastPosition) {
                        // Вычисляем расстояние между последней и новой позицией
                        const dist = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(lastPosition.lat, lastPosition.lng),
                            new google.maps.LatLng(newPos.lat, newPos.lng)
                        );
                        totalDistance += dist; // Расстояние в метрах
                    }
                    lastPosition = newPos;
                    pathCoordinates.push(newPos); // Добавляем новую координату к пути
                    pathPolyline.setPath(pathCoordinates); // Обновляем полилинию на карте

                    const currentTime = new Date().getTime();
                    const elapsedTime = (currentTime - startTime) / 1000; // Время в секундах
                    const currentSpeedMps = position.coords.speed || 0; // Скорость в метрах в секунду
                    const currentSpeedKmh = currentSpeedMps * 3.6; // Скорость в км/ч

                    // Обновляем статистику на экране
                    document.getElementById('current-speed').textContent = currentSpeedKmh.toFixed(2);
                    document.getElementById('distance-traveled').textContent = (totalDistance / 1000).toFixed(2); // Расстояние в км

                    const hours = Math.floor(elapsedTime / 3600);
                    const minutes = Math.floor((elapsedTime % 3600) / 60);
                    const seconds = Math.floor(elapsedTime % 60);
                    document.getElementById('time-elapsed').textContent =
                        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    const avgSpeedKmh = (totalDistance / 1000) / (elapsedTime / 3600) || 0;
                    document.getElementById('average-speed').textContent = avgSpeedKmh.toFixed(2);

                },
                (error) => {
                    // Обработка ошибок при отслеживании
                    console.error("Geolocation tracking error:", error);
                    let errorMessage = "Ошибка отслеживания GPS: ";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += "Доступ к местоположению запрещен. Пожалуйста, разрешите доступ к GPS в настройках браузера.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += "Информация о местоположении недоступна. Пожалуйста, проверьте сигнал GPS.";
                            break;
                        case error.TIMEOUT:
                            errorMessage += "Время ожидания запроса местоположения истекло. Пожалуйста, попробуйте еще раз.";
                            break;
                        default:
                            errorMessage += "Неизвестная ошибка: " + error.message;
                            break;
                    }
                    document.getElementById('map-status').textContent = errorMessage;
                    showModal(errorMessage + " Отслеживание остановлено.");
                    stopTracking(); // Останавливаем отслеживание при ошибке
                },
                {
                    enableHighAccuracy: true, // Высокая точность
                    maximumAge: 0, // Не использовать кэшированные позиции
                    timeout: 5000 // Таймаут для получения позиции
                }
            );
        });

        // Слушатель для кнопки "Остановить"
        document.getElementById('stop-tracking-btn').addEventListener('click', stopTracking);

        // Функция остановки отслеживания
        function stopTracking() {
            if (trackingId !== null) {
                navigator.geolocation.clearWatch(trackingId); // Отключаем отслеживание
                trackingId = null;
                document.getElementById('map-status').textContent = 'Отслеживание остановлено.';
                console.log("Tracking stopped.");

                // Скрываем целевой маршрут, если он был показан
                if (targetRoutePolyline) targetRoutePolyline.setMap(null);
                repeatingRoutePath = null; // Сбрасываем повторяемый маршрут

                // Включаем кнопку "Начать" и отключаем "Остановить" и "Поделиться"
                document.getElementById('start-tracking-btn').disabled = false;
                document.getElementById('stop-tracking-btn').disabled = true;
                document.getElementById('share-route-btn').disabled = false;

                // Сохраняем маршрут, если он был записан и пользователь вошел
                if (pathCoordinates.length > 1 && currentAppUser) {
                    saveRoute();
                } else if (!currentAppUser) {
                    showModal("Для сохранения маршрута необходимо войти в систему.");
                }
            }
        }

        // --- Сохранение маршрута в Firestore ---
        async function saveRoute() {
            if (!currentAppUser || !db) {
                console.error("Cannot save route: User not logged in or Firebase not initialized.");
                showModal("Ошибка сохранения маршрута: Пользователь не вошел в систему.");
                return;
            }

            const durationMs = new Date().getTime() - startTime;
            const durationSeconds = durationMs / 1000;
            const avgSpeedKmh = (totalDistance / 1000) / (durationSeconds / 3600) || 0;

            const routeData = {
                userId: currentAppUser,
                timestamp: new Date().toISOString(),
                duration: durationSeconds, // в секундах
                distance: totalDistance / 1000, // в км
                avgSpeed: avgSpeedKmh, // в км/ч
                path: JSON.stringify(pathCoordinates), // Храним как строку из-за ограничений Firestore для массивов
                type: document.getElementById('movement-type-select').value,
                movementMode: getSelectedMovementMode(),
                isFavorite: false, // Новое поле: по умолчанию не избранный
                popularityScore: Math.floor(Math.random() * 100) + 1 // Случайный счет для демонстрации "рекомендуемых"
            };

            try {
                // Путь к коллекции маршрутов пользователя
                const routesCollectionRef = collection(db, `artifacts/${appId}/public/data/namedUsers/${currentAppUser}/routes`);
                const docRef = await addDoc(routesCollectionRef, routeData); // Добавляем новый документ
                console.log("Route saved successfully with ID:", docRef.id);
                showModal("Маршрут успешно сохранен!");

                // Обновляем общую статистику пользователя для рейтинга
                await updateUserStats(currentAppUser, routeData.distance, routeData.duration);

                loadUserRoutes(currentAppUser); // Перезагружаем маршруты, чтобы показать новый
            } catch (error) {
                console.error("Error saving route:", error);
                showModal("Ошибка сохранения маршрута: " + error.message);
            }
        }

        // --- Переключение статуса "Избранное" ---
        async function toggleFavorite(routeId, currentIsFavorite) {
            if (!currentAppUser || !db) {
                showModal("Для добавления в избранное необходимо войти в систему.");
                return;
            }
            try {
                const routeDocRef = doc(db, `artifacts/${appId}/public/data/namedUsers/${currentAppUser}/routes`, routeId);
                await updateDoc(routeDocRef, {
                    isFavorite: !currentIsFavorite
                });
                console.log(`Route ${routeId} favorite status toggled to ${!currentIsFavorite}`);
                showModal(`Маршрут ${!currentIsFavorite ? 'добавлен в' : 'удален из'} избранного.`);
                loadUserRoutes(currentAppUser); // Обновляем список "Мои маршруты"
                loadFavoriteRoutes(currentAppUser); // Обновляем список "Избранное"
            } catch (error) {
                console.error("Error toggling favorite status:", error);
                showModal("Ошибка изменения статуса избранного: " + error.message);
            }
        }


        // Обновление статистики пользователя для таблицы лидеров
        async function updateUserStats(username, distanceKm, durationSeconds) {
            if (!db) return;

            const userDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, username);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    // Если документ существует, обновляем его
                    const data = docSnap.data();
                    await updateDoc(userDocRef, {
                        totalDistance: (data.totalDistance || 0) + distanceKm,
                        totalTime: (data.totalTime || 0) + durationSeconds,
                        lastActivity: new Date().toISOString()
                    });
                } else {
                    // Если документа нет, создаем его
                    await setDoc(userDocRef, {
                        displayName: username,
                        totalDistance: distanceKm,
                        totalTime: durationSeconds,
                        lastActivity: new Date().toISOString()
                    });
                }
                console.log("User stats updated for leaderboard.");
                loadLeaderboard(); // Перезагружаем рейтинг после обновления статистики
            } catch (error) {
                console.error("Error updating user stats:", error);
            }
        }

        // Получение выбранного подтипа передвижения
        function getSelectedMovementMode() {
            const movementType = document.getElementById('movement-type-select').value;
            let mode = '';
            if (movementType === 'walking') {
                mode = document.querySelector('input[name="walking-mode"]:checked')?.value || 'walk';
            } else if (movementType === 'cycling') {
                mode = document.querySelector('input[name="cycling-mode"]:checked')?.value || 'balanced';
            }
            return mode;
        }

        // --- Загрузка маршрутов пользователя ---
        async function loadUserRoutes(username) {
            if (!username || !db) {
                console.warn("Cannot load routes: User not logged in or Firebase not initialized.");
                return;
            }

            const routesListDiv = document.getElementById('routes-list');
            routesListDiv.innerHTML = '<p class="text-gray-500">Загрузка маршрутов...</p>';

            try {
                // Запрос для получения последних 6 маршрутов пользователя, отсортированных по дате
                const q = query(
                    collection(db, `artifacts/${appId}/public/data/namedUsers/${username}/routes`),
                    orderBy("timestamp", "desc"), // Сортировка по убыванию даты
                    limit(6) // Ограничение до последних 6 маршрутов
                );

                // Используем onSnapshot для получения обновлений в реальном времени
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        routesListDiv.innerHTML = '<p class="text-gray-500">Маршруты пока не найдены.</p>';
                        return;
                    }

                    routesListDiv.innerHTML = ''; // Очищаем список перед загрузкой новых маршрутов
                    snapshot.forEach((doc) => {
                        const route = doc.data();
                        const routeId = doc.id; // Получаем ID документа
                        const routePath = JSON.parse(route.path); // Парсим путь обратно из строки
                        const date = new Date(route.timestamp).toLocaleString();
                        const durationFormatted = formatDuration(route.duration);
                        const isFavorite = route.isFavorite || false; // Получаем статус избранного

                        const routeCard = document.createElement('div');
                        routeCard.className = 'card p-4 border-l-4 border-blue-500';
                        routeCard.innerHTML = `
                            <p class="font-semibold text-lg mb-1">${date}</p>
                            <p class="text-gray-700">Тип: ${route.type} (${route.movementMode})</p>
                            <p class="text-gray-700">Расстояние: ${route.distance.toFixed(2)} км</p>
                            <p class="text-gray-700">Время: ${durationFormatted}</p>
                            <p class="text-gray-700">Ср. скорость: ${route.avgSpeed.toFixed(2)} км/ч</p>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <button class="btn btn-secondary btn-sm view-route-btn" data-route='${JSON.stringify(routePath)}'><i class="fas fa-map-marked-alt"></i> Показать на карте</button>
                                <button class="btn btn-secondary btn-sm favorite-btn" data-route-id="${routeId}" data-is-favorite="${isFavorite}"><i class="${isFavorite ? 'fas fa-star text-yellow-500' : 'far fa-star'}"></i> ${isFavorite ? 'В избранном' : 'В избранное'}</button>
                                <button class="btn btn-primary btn-sm repeat-route-btn" data-route='${JSON.stringify(routePath)}'><i class="fas fa-redo"></i> Повторить</button>
                            </div>
                        `;
                        routesListDiv.appendChild(routeCard);
                    });

                    // Добавляем слушатели событий для кнопок "Показать на карте", "В избранное" и "Повторить"
                    document.querySelectorAll('.view-route-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const routePath = JSON.parse(event.target.dataset.route);
                            displayRouteOnMap(routePath);
                        });
                    });
                    document.querySelectorAll('.favorite-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const routeId = event.target.dataset.routeId;
                            const isFavorite = event.target.dataset.isFavorite === 'true';
                            toggleFavorite(routeId, isFavorite);
                        });
                    });
                    document.querySelectorAll('.repeat-route-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const routePath = JSON.parse(event.target.dataset.route);
                            promptRepeatRoute(routePath);
                        });
                    });
                });
            } catch (error) {
                console.error("Error loading user routes:", error);
                routesListDiv.innerHTML = '<p class="text-red-500">Ошибка загрузки маршрутов: ' + error.message + '</p>';
            }
        }

        // --- Загрузка избранных маршрутов ---
        async function loadFavoriteRoutes(username) {
            if (!username || !db) {
                console.warn("Cannot load favorite routes: User not logged in or Firebase not initialized.");
                return;
            }

            const favoritesListDiv = document.getElementById('favorites-list');
            favoritesListDiv.innerHTML = '<p class="text-gray-500">Загрузка избранных маршрутов...</p>';

            try {
                const q = query(
                    collection(db, `artifacts/${appId}/public/data/namedUsers/${username}/routes`),
                    where("isFavorite", "==", true),
                    orderBy("timestamp", "desc") // Сортировка по убыванию даты
                );

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        favoritesListDiv.innerHTML = '<p class="text-gray-500">Избранные маршруты пока не найдены.</p>';
                        return;
                    }

                    favoritesListDiv.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const route = doc.data();
                        const routeId = doc.id;
                        const routePath = JSON.parse(route.path);
                        const date = new Date(route.timestamp).toLocaleString();
                        const durationFormatted = formatDuration(route.duration);

                        const routeCard = document.createElement('div');
                        routeCard.className = 'card p-4 border-l-4 border-yellow-500'; // Желтая полоса для избранных
                        routeCard.innerHTML = `
                            <p class="font-semibold text-lg mb-1">${date}</p>
                            <p class="text-gray-700">Тип: ${route.type} (${route.movementMode})</p>
                            <p class="text-gray-700">Расстояние: ${route.distance.toFixed(2)} км</p>
                            <p class="text-gray-700">Время: ${durationFormatted}</p>
                            <p class="text-gray-700">Ср. скорость: ${route.avgSpeed.toFixed(2)} км/ч</p>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <button class="btn btn-secondary btn-sm view-route-btn" data-route='${JSON.stringify(routePath)}'><i class="fas fa-map-marked-alt"></i> Показать на карте</button>
                                <button class="btn btn-secondary btn-sm favorite-btn" data-route-id="${routeId}" data-is-favorite="true"><i class="fas fa-star text-yellow-500"></i> В избранном</button>
                                <button class="btn btn-primary btn-sm repeat-route-btn" data-route='${JSON.stringify(routePath)}'><i class="fas fa-redo"></i> Повторить</button>
                            </div>
                        `;
                        favoritesListDiv.appendChild(routeCard);
                    });

                    document.querySelectorAll('#favorites-list .view-route-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const routePath = JSON.parse(event.target.dataset.route);
                            displayRouteOnMap(routePath);
                        });
                    });
                     document.querySelectorAll('#favorites-list .favorite-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const routeId = event.target.dataset.routeId;
                            const isFavorite = event.target.dataset.isFavorite === 'true';
                            toggleFavorite(routeId, isFavorite);
                        });
                    });
                    document.querySelectorAll('#favorites-list .repeat-route-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const routePath = JSON.parse(event.target.dataset.route);
                            promptRepeatRoute(routePath);
                        });
                    });
                });
            } catch (error) {
                console.error("Error loading favorite routes:", error);
                favoritesListDiv.innerHTML = '<p class="text-red-500">Ошибка загрузки избранных маршрутов: ' + error.message + '</p>';
            }
        }


        // --- Загрузка таблицы лидеров ---
        async function loadLeaderboard() {
            if (!db) {
                console.warn("Cannot load leaderboard: Firebase not initialized.");
                return;
            }

            const leaderboardListDiv = document.getElementById('leaderboard-list');
            leaderboardListDiv.innerHTML = '<p class="text-gray-500">Загрузка рейтинга...</p>';

            try {
                // Запрос для получения топ-10 пользователей по общему расстоянию
                const q = query(
                    collection(db, `artifacts/${appId}/public/data/leaderboard`),
                    orderBy("totalDistance", "desc"), // Сортировка по общему расстоянию
                    limit(10) // Показать топ-10
                );

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        leaderboardListDiv.innerHTML = '<p class="text-gray-500">Рейтинг пока пуст.</p>';
                        return;
                    }

                    leaderboardListDiv.innerHTML = ''; // Очищаем список перед загрузкой
                    let rank = 1;
                    snapshot.forEach((doc) => {
                        const userStats = doc.data();
                        const totalTimeFormatted = formatDuration(userStats.totalTime || 0);

                        const leaderCard = document.createElement('div');
                        leaderCard.className = 'card p-4 flex items-center justify-between';
                        leaderCard.innerHTML = `
                            <div class="flex items-center">
                                <span class="text-xl font-bold mr-3 text-purple-600">${rank}.</span>
                                <p class="font-semibold text-lg">${userStats.displayName}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-700">Расстояние: <span class="font-bold text-blue-600">${(userStats.totalDistance || 0).toFixed(2)}</span> км</p>
                                <p class="text-gray-700">Время: <span class="font-bold text-green-600">${totalTimeFormatted}</span></p>
                            </div>
                        `;
                        leaderboardListDiv.appendChild(leaderCard);
                        rank++;
                    });
                });
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardListDiv.innerHTML = '<p class="text-red-500">Ошибка загрузки рейтинга: ' + error.message + '</p>';
            }
        }

        // --- Загрузка рекомендуемых маршрутов (на основе popularityScore) ---
        async function loadRecommendedRoutes() {
            if (!db) {
                console.warn("Cannot load recommended routes: Firebase not initialized.");
                return;
            }

            const recommendedListDiv = document.getElementById('recommended-list');
            recommendedListDiv.innerHTML = '<p class="text-gray-500">Загрузка рекомендуемых маршрутов...</p>';

            try {
                // Для демонстрации, берем все маршруты и сортируем по popularityScore
                // В реальном приложении здесь была бы более сложная логика рекомендаций
                const q = query(
                    collection(db, `artifacts/${appId}/public/data/namedUsers`), // Ищем по всем пользователям
                    // orderBy("popularityScore", "desc"), // Firestore не поддерживает orderBy на подколлекциях без сложных правил безопасности или агрегации
                    // Чтобы обойти ограничение, мы будем получать все маршруты и сортировать их на клиенте.
                    // В реальном приложении, если нужна сортировка по popularityScore,
                    // popularityScore должен быть агрегирован на уровне пользователя или в отдельной коллекции.
                );

                // Получаем все маршруты из всех пользователей (это может быть неэффективно для большого количества данных)
                // Для более масштабируемого решения, популярные маршруты должны храниться в отдельной коллекции.
                const allRoutes = [];
                const usersSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/namedUsers`));
                for (const userDoc of usersSnapshot.docs) {
                    const routesSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/namedUsers/${userDoc.id}/routes`));
                    routesSnapshot.forEach(routeDoc => {
                        allRoutes.push({ id: routeDoc.id, ...routeDoc.data() });
                    });
                }

                // Сортируем маршруты по popularityScore на клиенте
                allRoutes.sort((a, b) => (b.popularityScore || 0) - (a.popularityScore || 0));

                if (allRoutes.length === 0) {
                    recommendedListDiv.innerHTML = '<p class="text-gray-500">Рекомендуемые маршруты пока не найдены.</p>';
                    return;
                }

                recommendedListDiv.innerHTML = '';
                allRoutes.slice(0, 10).forEach((route) => { // Показываем топ-10
                    const routePath = JSON.parse(route.path);
                    const date = new Date(route.timestamp).toLocaleString();
                    const durationFormatted = formatDuration(route.duration);

                    const routeCard = document.createElement('div');
                    routeCard.className = 'card p-4 border-l-4 border-green-500'; // Зеленая полоса для рекомендуемых
                    routeCard.innerHTML = `
                        <p class="font-semibold text-lg mb-1">${date} (Пользователь: ${route.userId})</p>
                        <p class="text-gray-700">Тип: ${route.type} (${route.movementMode})</p>
                        <p class="text-gray-700">Расстояние: ${route.distance.toFixed(2)} км</p>
                        <p class="text-gray-700">Время: ${durationFormatted}</p>
                        <p class="text-gray-700">Ср. скорость: ${route.avgSpeed.toFixed(2)} км/ч</p>
                        <p class="text-gray-700">Рейтинг: <span class="font-bold text-orange-600">${route.popularityScore || 0}</span></p>
                        <div class="flex flex-wrap gap-2 mt-3">
                            <button class="btn btn-secondary btn-sm view-route-btn" data-route='${JSON.stringify(routePath)}'><i class="fas fa-map-marked-alt"></i> Показать на карте</button>
                            <button class="btn btn-primary btn-sm repeat-route-btn" data-route='${JSON.stringify(routePath)}'><i class="fas fa-redo"></i> Повторить</button>
                        </div>
                    `;
                    recommendedListDiv.appendChild(routeCard);
                });

                document.querySelectorAll('#recommended-list .view-route-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const routePath = JSON.parse(event.target.dataset.route);
                        displayRouteOnMap(routePath);
                    });
                });
                document.querySelectorAll('#recommended-list .repeat-route-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const routePath = JSON.parse(event.target.dataset.route);
                        promptRepeatRoute(routePath);
                    });
                });

            } catch (error) {
                console.error("Error loading recommended routes:", error);
                recommendedListDiv.innerHTML = '<p class="text-red-500">Ошибка загрузки рекомендуемых маршрутов: ' + error.message + '</p>';
            }
        }


        // Вспомогательная функция для форматирования длительности (секунды в HH:MM:SS)
        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // Отображение маршрута на карте
        function displayRouteOnMap(routePath) {
            if (!map) {
                showModal("Карта еще не загружена.");
                return;
            }
            if (routePath && routePath.length > 0) {
                // Скрываем текущий путь пользователя, если он есть
                pathPolyline.setPath([]);
                // Показываем целевой маршрут
                targetRoutePolyline.setPath(routePath);
                targetRoutePolyline.setMap(map);

                const bounds = new google.maps.LatLngBounds();
                routePath.forEach(coord => bounds.extend(coord)); // Расширяем границы карты
                map.fitBounds(bounds); // Подгоняем карту под границы маршрута
                showModal("Маршрут отображен на карте. Нажмите 'Повторить', чтобы начать следовать по нему.");
            } else {
                showModal("Маршрут пуст или недействителен.");
            }
        }

        // --- Функция повторения маршрута ---
        function promptRepeatRoute(routePath) {
            repeatingRoutePath = routePath; // Сохраняем путь для повторения
            repeatConfirmModal.style.display = 'flex'; // Показываем модальное окно подтверждения
        }

        document.getElementById('confirm-repeat-btn').addEventListener('click', () => {
            repeatConfirmModal.style.display = 'none'; // Скрываем модальное окно
            if (repeatingRoutePath) {
                // Сбрасываем текущее отслеживание, если оно активно
                if (trackingId !== null) {
                    navigator.geolocation.clearWatch(trackingId);
                }
                // Начинаем новое отслеживание, которое будет следовать по repeatingRoutePath
                document.getElementById('start-tracking-btn').click(); // Инициируем нажатие кнопки "Начать"
            }
        });


        // --- Логика обмена маршрутом ---
        document.getElementById('share-route-btn').addEventListener('click', () => {
            if (pathCoordinates.length === 0) {
                showModal("Сначала запишите маршрут, чтобы поделиться им.");
                return;
            }
            // В реальном приложении это сгенерировало бы уникальную ссылку на маршрут.
            // Для этой демонстрации мы симулируем это.
            const routeLink = `https://sprinttrack.app/route/${currentAppUser}/${new Date().getTime()}`; // Пример ссылки
            const shareMessage = `Я только что проехал ${document.getElementById('distance-traveled').textContent} км за ${document.getElementById('time-elapsed').textContent} на SprintTrack! Присоединяйся ко мне: ${routeLink}`;

            // Симулируем обмен в мессенджере (копируем в буфер обмена)
            const tempInput = document.createElement('textarea');
            tempInput.value = shareMessage;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy'); // Копируем текст в буфер обмена
            document.body.removeChild(tempInput);

            showModal("Маршрут скопирован в буфер обмена! Вы можете вставить его в любой мессенджер.");
        });

        // --- Функция SOS ---
        function handleSOS() {
            const sosModal = document.getElementById('sos-modal');
            const sosLocationElement = document.getElementById('sos-location');
            sosLocationElement.textContent = "Определение местоположения...";
            sosModal.style.display = 'flex';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        sosLocationElement.innerHTML = `Широта: ${lat}, Долгота: ${lng}<br>Отправлено экстренным контактам.`;
                        // В реальном приложении здесь будет отправлен запрос на сервер
                        // с координатами для оповещения экстренных служб или контактов.
                        console.log(`SOS: Отправлено местоположение - Lat: ${lat}, Lng: ${lng}`);
                    },
                    (error) => {
                        sosLocationElement.textContent = "Не удалось определить местоположение. Проверьте настройки GPS.";
                        console.error("SOS Geolocation Error:", error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                sosLocationElement.textContent = "Ваш браузер не поддерживает геолокацию.";
            }
        }


        // --- Логика UI для выбора типа передвижения ---
        const movementTypeSelect = document.getElementById('movement-type-select');
        const walkingOptions = document.getElementById('walking-options');
        const cyclingOptions = document.getElementById('cycling-options');
        const ebikeOptions = document.getElementById('ebike-options');
        const smoothRideOptions = document.getElementById('smooth-ride-options'); // Это описание, не отдельный тип
        const roadbikeOptions = document.getElementById('roadbike-options');
        const mountainbikeOptions = document.getElementById('mountainbike-options');

        function updateMovementOptionsVisibility() {
            // Скрываем все опции по умолчанию
            walkingOptions.classList.add('hidden');
            cyclingOptions.classList.add('hidden');
            ebikeOptions.classList.add('hidden');
            smoothRideOptions.classList.add('hidden');
            roadbikeOptions.classList.add('hidden');
            mountainbikeOptions.classList.add('hidden');

            const selectedType = movementTypeSelect.value;
            // Показываем соответствующие опции в зависимости от выбора
            if (selectedType === 'walking') {
                walkingOptions.classList.remove('hidden');
            } else if (selectedType === 'cycling') {
                cyclingOptions.classList.remove('hidden');
            } else if (selectedType === 'ebike') {
                ebikeOptions.classList.remove('hidden');
            } else if (selectedType === 'roadbike') {
                roadbikeOptions.classList.remove('hidden');
            }
            // Примечание: 'Популярные' и 'Плавная езда' являются под-опциями или общими концепциями,
            // а не отдельными типами в этом выпадающем списке. Они описаны в разделе "Велосипед".
            else if (selectedType === 'mountainbike') {
                mountainbikeOptions.classList.remove('hidden');
            }
        }

        movementTypeSelect.addEventListener('change', updateMovementOptionsVisibility);
        // Вызываем функцию при загрузке страницы, чтобы установить правильную видимость
        updateMovementOptionsVisibility();


        // --- Логика переключения вкладок ---
        const historyTabBtn = document.getElementById('history-tab-btn');
        const favoritesTabBtn = document.getElementById('favorites-tab-btn');
        const leaderboardTabBtn = document.getElementById('leaderboard-tab-btn');
        const recommendedTabBtn = document.getElementById('recommended-tab-btn');

        const historyContent = document.getElementById('history-content');
        const favoritesContent = document.getElementById('favorites-content');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const recommendedContent = document.getElementById('recommended-content');

        function activateTab(tabName) {
            // Скрываем весь контент вкладок
            historyContent.classList.add('hidden');
            favoritesContent.classList.add('hidden');
            leaderboardContent.classList.add('hidden');
            recommendedContent.classList.add('hidden');

            // Деактивируем все кнопки вкладок
            historyTabBtn.classList.remove('active');
            favoritesTabBtn.classList.remove('active');
            leaderboardTabBtn.classList.remove('active');
            recommendedTabBtn.classList.remove('active');

            // Активируем выбранную вкладку и показываем ее контент
            if (tabName === 'history') {
                historyContent.classList.remove('hidden');
                historyTabBtn.classList.add('active');
                if (currentAppUser) loadUserRoutes(currentAppUser);
            } else if (tabName === 'favorites') {
                favoritesContent.classList.remove('hidden');
                favoritesTabBtn.classList.add('active');
                if (currentAppUser) loadFavoriteRoutes(currentAppUser);
            } else if (tabName === 'leaderboard') {
                leaderboardContent.classList.remove('hidden');
                leaderboardTabBtn.classList.add('active');
                loadLeaderboard();
            } else if (tabName === 'recommended') {
                recommendedContent.classList.remove('hidden');
                recommendedTabBtn.classList.add('active');
                loadRecommendedRoutes();
            }
        }

        historyTabBtn.addEventListener('click', () => activateTab('history'));
        favoritesTabBtn.addEventListener('click', () => activateTab('favorites'));
        leaderboardTabBtn.addEventListener('click', () => activateTab('leaderboard'));
        recommendedTabBtn.addEventListener('click', () => activateTab('recommended'));

        // Активируем вкладку "Мои маршруты" по умолчанию при загрузке
        activateTab('history');


        // --- Загрузка скрипта Google Maps ---
        // Эта функция будет вызвана после готовности DOM для внедрения скрипта Google Maps
        function loadGoogleMapsScript() {
            const googleMapsApiKey = "AIzaSyA-1e8Lc2h93OtiUMT3jLDJnIHeOYIYTh0"; // Ваш реальный ключ API
            if (!googleMapsApiKey) {
                showModal("Ошибка: Отсутствует ключ Google Maps API. Пожалуйста, убедитесь, что ключ API указан в коде.");
                document.getElementById('map-status').textContent = "Ошибка: Отсутствует ключ Google Maps API.";
                return;
            }

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&libraries=geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                document.getElementById('map-status').textContent = "Ошибка загрузки Google Maps API. Проверьте ключ и подключение к интернету.";
                showModal("Ошибка загрузки Google Maps API. Проверьте ключ и подключение к интернету.");
            };
            document.head.appendChild(script);
        }

        // Убедитесь, что DOM полностью загружен, прежде чем пытаться инициализировать карту или прикреплять слушатели
        document.addEventListener('DOMContentLoaded', () => {
            loadGoogleMapsScript();
        });

    </script>
</body>
</html>
